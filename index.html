<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfect TimeLine with Full Navigation</title>

  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet"/>

  <style>
    :root{
      --accent: #77a9b4;
      --icon-on-dark: #eaf6ff; 
      --panel-hover: rgba(6, 28, 56, 0.72); 
      --panel-border: rgba(119,169,180,0.45);
      --panel-glow: rgba(119,169,180,0.25);
      --text-soft: #cfe4ee;
      --value-bright: #9eefff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: Arial, sans-serif;
      scroll-snap-type: y mandatory;
      overflow-x: hidden;
    }

    .section {
      height: 100vh;
      width: 100vw;
      scroll-snap-align: start;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .timeline-section {
      overflow: hidden;
      scroll-snap-align: start;
     }

    .time-line {
      overflow-x: auto;
      display: flex;
      gap: 35rem;
      padding: 2rem 15rem;
      align-items: flex-start;
      width: 100vw;
      height: 100vh;
    }
    .time-line::-webkit-scrollbar { display: none; }

    .start-point {
      margin-top: 20rem;
      margin-bottom: 20rem;
      background-color: var(--accent);
      width: 6px;
      height: 80px;
      border-radius: 2px;
      animation: grow-from-center 0.5s forwards;
      transform: scaleY(0);
      transform-origin: center;
      flex-shrink: 0;
      position: relative;
    }
    .start-point::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 100%;
      width: 35rem;
      height: 4px;
      background-color: var(--accent);
      transform: translateY(-50%) scaleX(0);
      transform-origin: left center;
      animation: extend-blade 0.6s 0.5s forwards;
    }
    .start-point .line-text {
      position: absolute;
      top: 10px;
      left: 12.5rem;
      color: white;
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
      opacity: 0;
      animation: fadeIn 0.5s ease-out 1.1s forwards;
    }
    @keyframes grow-from-center {
      to { transform: scaleY(1); }
    }
    @keyframes extend-blade {
      from { transform: translateY(-50%) scaleX(0); }
      to   { transform: translateY(-50%) scaleX(1); }
    }

    .point {
      margin-top: 20rem;
      border-radius: 100%;
      background-color: var(--accent);
      width: 30px;
      height: 30px;
      position: relative;
      flex-shrink: 0;
      z-index: 10;
      transform: translateY(calc(40px - 15px));
    }
    .point::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 100%;
      width: 35rem;
      height: 4px;
      background-color: var(--accent);
      transform: translateY(-50%) scaleX(0);
      transform-origin: left center;
      z-index: 12;
    }
    .point:last-child::after {
      display: none;
    }
    .point:last-child {
      margin-right: 50rem;
    }

    .line-text {
      position: absolute;
      left: 12.5rem;
      color: white;
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
      opacity: 0;
      z-index: 15;
    }
    .point[data-circle="1"] .line-text { top: 28px; }
    .point[data-circle="2"] .line-text { top: -20px; }
    .point[data-circle="3"] .line-text { top: 28px; }
    .point[data-circle="4"] .line-text { top: -20px; }
    .point[data-circle="5"] .line-text { top: 28px; }
    .point[data-circle="6"] .line-text { top: -20px; }
    .point[data-circle="7"] .line-text { top: 28px; }
    .point[data-circle="8"] .line-text { top: -20px; }
    .point[data-circle="9"] .line-text { top: 28px; }

    .line-text.show {
      opacity: 1;
      animation: fadeIn 0.5s ease-out forwards;
    }

    @keyframes extend-segment {
      from { transform: translateY(-50%) scaleX(0); }
      to   { transform: translateY(-50%) scaleX(1); }
    }

    .point::before {
      content: '';
      position: absolute;
      top: -30px;
      left: 50%;
      width: 4px;
      border: 100%;
      height: 30px;
      background-color: var(--accent);
      transform: translateX(-50%) scaleY(0);
      transform-origin: bottom center;
      opacity: 0;
      z-index: 30;
    }
    .point.top-extended::before {
      height: 105px;
      top: -105px;
      z-index: 30;
    }

    .inner-dot {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 24px;
      height: 24px;
      background-color: #0000006c;
      border-radius: 100%;
      transform: translate(-50%, -50%);
      z-index: 11;
    }
    .center-dot {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 8px;
      height: 8px;
      background-color: var(--accent);
      border-radius: 100%;
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      z-index: 12;
    }
    .center-dot.animate {
      animation: center-dot-appear 0.6s ease-out forwards;
    }
    @keyframes center-dot-appear {
      0%   { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      1%   { opacity: 1; }
      50%  { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .point.extend-line::after {
      animation: extend-segment 1.4s ease-out forwards;
    }
    .point.extend-vertical-lines::before {
      animation: extend-vertical-top 1s ease-out forwards;
    }
    .point.extend-vertical-lines .bottom-line {
      animation: extend-vertical-bottom 1s ease-out forwards;
    }
    @keyframes extend-vertical-top {
      from { transform: translateX(-50%) scaleY(0); opacity: 0; }
      to   { transform: translateX(-50%) scaleY(1); opacity: 1; }
    }
    @keyframes extend-vertical-bottom {
      from { transform: translateX(-50%) scaleY(0); opacity: 0; }
      to   { transform: translateX(-50%) scaleY(1); opacity: 1; }
    }

    .bottom-line {
      position: absolute;
      top: 30px;
      left: 50%;
      width: 4px;
      height: 135px;
      background-color: var(--accent);
      transform: translateX(-50%) scaleY(0);
      transform-origin: top center;
      opacity: 0;
      z-index: 30;
    }
    .bottom-line.bottom-small {
      height: 30px;
      z-index: 30;
    }

    .year-label {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 25px;
      font-weight: bold;
      opacity: 0;
      z-index: 35;
      white-space: nowrap;
      transition: color .25s ease, text-shadow .25s ease, transform .25s ease;
    }
    .year-label.top-small { top: -55px; }
    .year-label.bottom-small { top: 70px; }
    .year-label.show {
      opacity: 1;
      animation: fadeIn 0.5s ease-out forwards;
    }
 
    .point:hover .year-label,
    .project-data:hover ~ .year-label {
      color: var(--icon-on-dark);
      text-shadow: 0 0 10px var(--panel-glow), 0 2px 6px rgba(0,0,0,.35);
      transform: translateX(-50%) scale(1.06);
      color: var(--value-bright) ;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    .project-data {
      position: absolute;
      color: var(--accent);
      font-size: 13px;
      line-height: 1.4;
      opacity: 0;
      width: 250px;
      padding: 15px 18px;
      background: rgba(0, 0, 0, 0);
      border-radius: 8px;
      backdrop-filter: blur(10px);
      left: 50%;
      transform: translateX(-50%) scale(1);
      z-index: 20;
      transition:
        transform .25s ease,
        background-color .25s ease,
        color .25s ease,
        box-shadow .25s ease,
        border-color .25s ease;
      will-change: transform;
      border: 1px solid transparent; 
    }
    .project-data.top-big { bottom: 135px; }
    .project-data.bottom-big { top: 165px; }
    .project-data.show {
      opacity: 1;
      animation: slideInUp 0.7s ease-out forwards;
    }
    @keyframes slideInUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .point:hover .project-data,
    .project-data:hover {
      transform: translateX(-50%) scale(1.05); 
      background-color: var(--panel-hover);
      border-color: var(--panel-border);
      box-shadow:
        0 10px 28px rgba(0,0,0,.35),
        0 0 0 1px rgba(119,169,180,0.15),
        0 0 18px var(--panel-glow);
      color: #e7f2f7;
    }

    .project-data .data-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--accent);
      font-size: 15px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      overflow: visible;
      transition: color .25s ease;
    }
    .project-data .data-header .ri {
      font-size: 18px;
      color: var(--icon-on-dark);
      text-shadow: 0 0 6px rgba(119,169,180,.35);
      flex: 0 0 auto;
      transition: color .25s ease, text-shadow .25s ease;
    }
    .project-data .data-header .data-title {
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      border-right: 2px solid #00ffff; 
      transition: color .25s ease, border-color .25s ease;
    }

    .point:hover .project-data .data-header,
    .project-data:hover .data-header {
      color: #d9ecf5;
    }
    .point:hover .project-data .data-header .ri,
    .project-data:hover .data-header .ri {
      color: var(--accent);
      text-shadow: 0 0 10px var(--panel-glow);
    }
    .point:hover .project-data .data-header .data-title,
    .project-data:hover .data-header .data-title {
      color: #ffffff;
      border-color: #8af6ff;
    }

    .project-data .data-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      align-items: center;
      overflow: hidden;
      transition: color .25s ease;
    }
    .project-data .data-label { font-size: 12px; color: #cccccc; transition: color .25s ease; }
    .project-data .data-value { font-weight: bold; color: #00ffff; transition: color .25s ease; }
    .project-data .projects-value { font-size: 20px; color: var(--accent); transition: color .25s ease; }
    .project-data .value-cr { font-size: 16px; color: var(--accent); transition: color .25s ease; }

    .point:hover .project-data .data-label,
    .project-data:hover .data-label {
      color: var(--text-soft);
    }
    .point:hover .project-data .data-value,
    .project-data:hover .data-value {
      color: var(--value-bright);
    }
    .point:hover .project-data .projects-value,
    .project-data:hover .projects-value {
      color: #c7e4ee;
    }
    .point:hover .project-data .value-cr,
    .project-data:hover .value-cr {
      color: #b9d6df;
    }

    .project-data .major-projects {
      margin-top: 10px;
      font-size: 11px;
      color: #cccccc;
      border-top: 1px solid rgba(0, 255, 255, 0.3);
      padding-top: 8px;
      overflow: hidden;
      transition: color .25s ease, border-color .25s ease;
    }
    .project-data .projects-list {
      color: #00ffff;
      font-size: 11px;
      margin-top: 5px;
      line-height: 1.3;
      overflow: hidden;
      transition: color .25s ease;
    }
    
    .point:hover .project-data .major-projects,
    .project-data:hover .major-projects {
      color: #d3e8f1;
      border-top-color: rgba(138, 246, 255, 0.4);
    }
    .point:hover .project-data .projects-list,
    .project-data:hover .projects-list {
      color: #aaf7ff;
    }
    
    .project-data.show .data-header .data-title {
      animation: typeWriter 0.8s steps(20, end) 0.9s forwards,
                 blinkCursor 0.5s step-end 0.9s 3;
    }
    @keyframes typeWriter {
      0% { width: 0; opacity: 0; }
      1% { opacity: 1; }
      100% { width: 100%; opacity: 1; }
    }
    @keyframes blinkCursor {
      0%, 50% { border-right: 2px solid #00ffff; }
      51%, 100% { border-right: 2px solid transparent; }
    }
    @keyframes fadeInSlide {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .project-data.show .data-row:nth-child(2) {
      animation: fadeInSlide 0.6s ease-out 1.1s forwards;
      opacity: 0;
    }
    .project-data.show .data-row:nth-child(3) {
      animation: fadeInSlide 0.6s ease-out 1.3s forwards;
      opacity: 0;
    }
    .project-data.show .major-projects {
      animation: fadeInSlide 0.6s ease-out 1.5s forwards;
      opacity: 0;
    }
    .project-data.show .projects-list {
      animation: typeWriter 0.8s steps(30, end) 1.7s forwards;
      opacity: 0;
    }
    .project-data.show .data-value.projects-value {
      animation: numberCount 0.8s ease-out 1.2s forwards;
      opacity: 0;
    }
    .project-data.show .data-value.value-cr {
      animation: numberCount 0.8s ease-out 1.4s forwards;
      opacity: 0;
    }
    @keyframes numberCount {
      0% { opacity: 0; transform: scale(0.5); }
      50% { transform: scale(1.1); }
      100% { opacity: 1; transform: scale(1); }
    }

    @media (prefers-reduced-motion: reduce) {
      .project-data, .year-label { transition: none !important; }
      .point:hover .project-data, .project-data:hover {
        transform: translateX(-50%) scale(1); 
      }
    }
  </style>
</head>
<body>

  <section class="section timeline-section" style="background-color: transparent;">
    <div class="time-line" id="timeline-scroll">
      <div class="start-point">
        <div class="line-text">Beginning of Journey</div>
      </div>

      <div class="point" data-circle="1" data-year="2005">
        <div class="inner-dot"></div>
        <div class="center-dot"></div>
        <div class="bottom-line"></div>
        <div class="year-label">2005</div>
        <div class="line-text">Foundation Era</div>
        <div class="project-data">
          <div class="data-header">
            <i class="ri-building-2-line" aria-hidden="true"></i>
            <span class="data-title">Construction Milestone</span>
          </div>
          <div class="data-row">
            <span class="data-label">Projects:</span>
            <span class="data-value projects-value">05</span>
          </div>
          <div class="data-row">
            <span class="data-label">Value:</span>
            <span class="data-value value-cr">‚Çπ300.35 CR</span>
          </div>
          <div class="major-projects">
            <div class="data-label">Major Projects:</div>
            <div class="projects-list">Residential Complex Alpha ‚Ä¢ Commercial Plaza Beta</div>
          </div>
        </div>
      </div>

      <div class="point" data-circle="2" data-year="2007">
        <div class="inner-dot"></div>
        <div class="center-dot"></div>
        <div class="bottom-line"></div>
        <div class="year-label">2007</div>
        <div class="line-text">Growth Phase</div>
        <div class="project-data">
          <div class="data-header">
            <i class="ri-tools-line" aria-hidden="true"></i>
            <span class="data-title">Infrastructure Growth</span>
          </div>
          <div class="data-row">
            <span class="data-label">Projects:</span>
            <span class="data-value projects-value">08</span>
          </div>
          <div class="data-row">
            <span class="data-label">Value:</span>
            <span class="data-value value-cr">‚Çπ450.20 CR</span>
          </div>
          <div class="major-projects">
            <div class="data-label">Major Projects:</div>
            <div class="projects-list">Metro Station Hub ‚Ä¢ Shopping Complex Gateway</div>
          </div>
        </div>
      </div>

      <div class="point" data-circle="3" data-year="2009">
        <div class="inner-dot"></div>
        <div class="center-dot"></div>
        <div class="bottom-line"></div>
        <div class="year-label">2009</div>
        <div class="line-text">Urban Focus</div>
        <div class="project-data">
          <div class="data-header">
            <i class="ri-community-line" aria-hidden="true"></i>
            <span class="data-title">Urban Development</span>
          </div>
          <div class="data-row">
            <span class="data-label">Projects:</span>
            <span class="data-value projects-value">12</span>
          </div>
          <div class="data-row">
            <span class="data-label">Value:</span>
            <span class="data-value value-cr">‚Çπ680.75 CR</span>
          </div>
          <div class="major-projects">
            <div class="data-label">Major Projects:</div>
            <div class="projects-list">Highway Bridge Delta ‚Ä¢ Residential Tower Prime</div>
          </div>
        </div>
      </div>

      <div class="point" data-circle="4" data-year="2010">
        <div class="inner-dot"></div>
        <div class="center-dot"></div>
        <div class="bottom-line"></div>
        <div class="year-label">2010</div>
        <div class="line-text">Commercial Boom</div>
        <div class="project-data">
          <div class="data-header">
            <i class="ri-store-2-line" aria-hidden="true"></i>
            <span class="data-title">Commercial Expansion</span>
          </div>
          <div class="data-row">
            <span class="data-label">Projects:</span>
            <span class="data-value projects-value">15</span>
          </div>
          <div class="data-row">
            <span class="data-label">Value:</span>
            <span class="data-value value-cr">‚Çπ920.40 CR</span>
          </div>
          <div class="major-projects">
            <div class="data-label">Major Projects:</div>
            <div class="projects-list">Airport Terminal ‚Ä¢ IT Park Horizon</div>
          </div>
        </div>
      </div>

      <div class="point" data-circle="5" data-year="2011">
        <div class="inner-dot"></div>
        <div class="center-dot"></div>
        <div class="bottom-line"></div>
        <div class="year-label">2011</div>
        <div class="line-text">Sports & Events</div>
        <div class="project-data">
          <div class="data-header">
            <i class="ri-trophy-line" aria-hidden="true"></i>
            <span class="data-title">Sports & Convention</span>
          </div>
          <div class="data-row">
            <span class="data-label">Projects:</span>
            <span class="data-value projects-value">18</span>
          </div>
          <div class="data-row">
            <span class="data-label">Value:</span>
            <span class="data-value value-cr">‚Çπ1250.60 CR</span>
          </div>
          <div class="major-projects">
            <div class="data-label">Major Projects:</div>
            <div class="projects-list">Sports Stadium Arena ‚Ä¢ Convention Center Elite</div>
          </div>
        </div>
      </div>

      <div class="point" data-circle="6" data-year="2012">
        <div class="inner-dot"></div>
        <div class="center-dot"></div>
        <div class="bottom-line"></div>
        <div class="year-label">2012</div>
        <div class="line-text">Healthcare Vision</div>
        <div class="project-data">
          <div class="data-header">
            <i class="ri-hospital-line" aria-hidden="true"></i>
            <span class="data-title">Healthcare & Business</span>
          </div>
          <div class="data-row">
            <span class="data-label">Projects:</span>
            <span class="data-value projects-value">22</span>
          </div>
          <div class="data-row">
            <span class="data-label">Value:</span>
            <span class="data-value value-cr">‚Çπ1580.85 CR</span>
          </div>
          <div class="major-projects">
            <div class="data-label">Major Projects:</div>
            <div class="projects-list">Business District Core ‚Ä¢ Medical College Campus</div>
          </div>
        </div>
      </div>

      <div class="point" data-circle="7" data-year="2016">
        <div class="inner-dot"></div>
        <div class="center-dot"></div>
        <div class="bottom-line"></div>
        <div class="year-label">2016</div>
        <div class="line-text">Smart City Era</div>
        <div class="project-data">
          <div class="data-header">
            <i class="ri-base-station-line" aria-hidden="true"></i>
            <span class="data-title">Smart Infrastructure</span>
          </div>
          <div class="data-row">
            <span class="data-label">Projects:</span>
            <span class="data-value projects-value">28</span>
          </div>
          <div class="data-row">
            <span class="data-label">Value:</span>
            <span class="data-value value-cr">‚Çπ2150.30 CR</span>
          </div>
          <div class="major-projects">
            <div class="data-label">Major Projects:</div>
            <div class="projects-list">Smart City Phase 1 ‚Ä¢ Port Expansion Project</div>
          </div>
        </div>
      </div>

      <div class="point" data-circle="8" data-year="2020">
        <div class="inner-dot"></div>
        <div class="center-dot"></div>
        <div class="bottom-line"></div>
        <div class="year-label">2020</div>
        <div class="line-text">Green Revolution</div>
        <div class="project-data">
          <div class="data-header">
            <i class="ri-leaf-line" aria-hidden="true"></i>
            <span class="data-title">Green Revolution</span>
          </div>
          <div class="data-row">
            <span class="data-label">Projects:</span>
            <span class="data-value projects-value">35</span>
          </div>
          <div class="data-row">
            <span class="data-label">Value:</span>
            <span class="data-value value-cr">‚Çπ3200.95 CR</span>
          </div>
          <div class="major-projects">
            <div class="data-label">Major Projects:</div>
            <div class="projects-list">Metro Line Extension ‚Ä¢ Green Building Initiative</div>
          </div>
        </div>
      </div>

      <div class="point" data-circle="9" data-year="2022">
        <div class="inner-dot"></div>
        <div class="center-dot"></div>
        <div class="bottom-line"></div>
        <div class="year-label">2022</div>
        <div class="line-text">Renewable Future</div>
        <div class="project-data">
          <div class="data-header">
            <i class="ri-sun-line" aria-hidden="true"></i>
            <span class="data-title">Renewable Energy</span>
          </div>
          <div class="data-row">
            <span class="data-label">Projects:</span>
            <span class="data-value projects-value">42</span>
          </div>
          <div class="data-row">
            <span class="data-label">Value:</span>
            <span class="data-value value-cr">‚Çπ4500.70 CR</span>
          </div>
          <div class="major-projects">
            <div class="data-label">Major Projects:</div>
            <div class="projects-list">Solar Park Mega ‚Ä¢ Industrial Complex Zone</div>
          </div>
        </div>
      </div>

      <div class="point" data-circle="10" data-year="2024">
        <div class="inner-dot"></div>
        <div class="center-dot"></div>
        <div class="bottom-line"></div>
        <div class="year-label">2024</div>
        <div class="project-data">
          <div class="data-header">
            <i class="ri-cpu-line" aria-hidden="true"></i>
            <span class="data-title">Future Technology</span>
          </div>
          <div class="data-row">
            <span class="data-label">Projects:</span>
            <span class="data-value projects-value">48</span>
          </div>
          <div class="data-row">
            <span class="data-label">Value:</span>
            <span class="data-value value-cr">‚Çπ5800.45 CR</span>
          </div>
          <div class="major-projects">
            <div class="data-label">Major Projects:</div>
            <div class="projects-list">Tech Hub Innovation ‚Ä¢ Sustainable Housing Project</div>
          </div>
        </div>
      </div>
    </div>
  </section>



  <script>
  (function($) {
      'use strict';
      
      if (typeof $ === 'undefined' || typeof jQuery === 'undefined') {
          console.error('‚ùå TIMELINE ERROR: jQuery not loaded');
          return;
      }
      
      console.log('üöÄ TIMELINE: Comprehensive fix version initialized');
      
      // ============================================
      // CONFIGURATION - OPTIMIZED VALUES
      // ============================================
      const CONFIG = {
          BOUNDARY_THRESHOLD: 30,
          SCROLL_ACCUMULATION_NEEDED: 60,
          SCROLL_RESET_DELAY: 400,
          TRANSITION_DURATION: 1000,
          TRANSITION_EASING: 'easeInOutCubic',
          SNAP_DISTANCE: 150,
          MIN_SCROLL_DELTA: 2,
          MOBILE_ADMIN_BAR_HEIGHT: 46,
          DESKTOP_ADMIN_BAR_HEIGHT: 32,
          MAP_SECTION_ID: '756f69f',
          LOCK_COOLDOWN: 1500,
          UNLOCK_GRACE_PERIOD: 500
      };
      
      // ============================================
      // STATE VARIABLES
      // ============================================
      let scrollContainer;
      let circles;
      let timelineSection;
      let $timelineWrapper;
      let animatedConnections = new Set();
      let scrollAccumulation = 0;
      let lastScrollDirection = 0;
      let isTransitioning = false;
      let isTimelineLocked = false;
      let viewportLocked = false;
      let scrollResetTimeout;
      let isWordPress = false;
      let adminBarHeight = 0;
      let preventScroll = false;
      let lastTransitionTime = 0;
      let justExitedTimeline = false;
      let allowPageScroll = false;
      let lockAttempts = 0;
      let timelineScrolledPast = false;
      let hasBeenBelowTimeline = false;  // NEW: Track if user has been below timeline
      
      // ============================================
      // UTILITY FUNCTIONS
      // ============================================
      function timeStamp() {
          return new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds().toString().padStart(3, '0');
      }
      
      function detectWordPressEnvironment() {
          isWordPress = $('body').hasClass('wp-admin') || 
                        $('body').hasClass('admin-bar') || 
                        $('#wpadminbar').length > 0;
          
          if (isWordPress) {
              const $adminBar = $('#wpadminbar');
              if ($adminBar.length > 0 && $adminBar.is(':visible')) {
                  adminBarHeight = $adminBar.outerHeight() || 0;
              } else if ($('body').hasClass('admin-bar')) {
                  adminBarHeight = $(window).width() <= 782 ? 
                      CONFIG.MOBILE_ADMIN_BAR_HEIGHT : 
                      CONFIG.DESKTOP_ADMIN_BAR_HEIGHT;
              }
          }
          
          return adminBarHeight;
      }
      
      function getScrollOffset() {
          let offset = adminBarHeight;
          
          const $stickyHeader = $('.header-position-absolute, .elementor-sticky, [data-sticky]').first();
          if ($stickyHeader.length > 0 && $stickyHeader.is(':visible')) {
              offset += $stickyHeader.outerHeight() || 0;
          }
          
          return Math.max(0, offset);
      }
      
      $.easing.easeInOutCubic = function(x) {
          return x < 0.5 ? 4 * x * x * x : 1 - Math.pow(-2 * x + 2, 3) / 2;
      };
      
      function isInCooldown() {
          const now = Date.now();
          return (now - lastTransitionTime) < CONFIG.LOCK_COOLDOWN;
      }
      
      // ============================================
      // RESET TIMELINE FUNCTION - IMPROVED
      // ============================================
      function resetTimelineToStart() {
          if (!scrollContainer) return;
          
          console.log('üîÑ Resetting timeline to START position');
          scrollContainer.scrollLeft = 0;
          
          // Reset animations
          initializeTimeline();
          
          // Re-trigger first circle animation
          setTimeout(() => {
              checkVisibleCircles();
          }, 100);
          
          // Reset flags
          timelineScrolledPast = true;
          hasBeenBelowTimeline = false;
      }
      
      // ============================================
      // VIEWPORT LOCK SYSTEM - IMPROVED
      // ============================================
      function lockViewportToTimeline(direction = 'down') {
          if (viewportLocked) {
              console.log('‚è∏Ô∏è Already locked');
              return;
          }
          
          if (justExitedTimeline || isInCooldown()) {
              console.log('‚è∏Ô∏è Cooldown active - preventing lock');
              lockAttempts++;
              if (lockAttempts > 3) {
                  console.log('‚ö†Ô∏è Too many lock attempts - resetting');
                  setTimeout(() => { lockAttempts = 0; }, 1000);
              }
              return;
          }
          
          console.log('üîí LOCKING viewport, direction:', direction);
          viewportLocked = true;
          preventScroll = true;
          allowPageScroll = false;
          lockAttempts = 0;
          timelineScrolledPast = false;
          hasBeenBelowTimeline = false;
          
          const scrollOffset = getScrollOffset();
          const targetTop = $timelineWrapper.offset().top - scrollOffset;
          
          $('html, body').stop(true, true);
          
          $('html, body').animate({
              scrollTop: targetTop
          }, {
              duration: CONFIG.TRANSITION_DURATION,
              easing: CONFIG.TRANSITION_EASING,
              complete: function() {
                  isTimelineLocked = true;
                  justExitedTimeline = false;
                  
                  if (scrollContainer) {
                      if (direction === 'down') {
                          scrollContainer.scrollLeft = 0;
                          console.log('‚úÖ Locked - START position');
                      } else {
                          const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
                          scrollContainer.scrollLeft = maxScroll;
                          console.log('‚úÖ Locked - END position');
                      }
                  }
              }
          });
      }
      
      function unlockViewport() {
          if (!viewportLocked) return;
          
          console.log('üîì UNLOCKING viewport');
          viewportLocked = false;
          preventScroll = false;
          isTimelineLocked = false;
          scrollAccumulation = 0;
          lastScrollDirection = 0;
          justExitedTimeline = true;
          allowPageScroll = true;
          lastTransitionTime = Date.now();
          
          setTimeout(() => {
              justExitedTimeline = false;
              console.log('‚úÖ Grace period ended');
          }, CONFIG.UNLOCK_GRACE_PERIOD);
      }
      
      function isTimelineInViewport() {
          if (!timelineSection) return false;
          
          const rect = timelineSection.getBoundingClientRect();
          const viewportHeight = $(window).height();
          
          return rect.top <= viewportHeight && rect.bottom >= 0;
      }
      
      function shouldLockToTimeline() {
          if (!timelineSection) return false;
          if (viewportLocked || isInCooldown()) return false;
          
          const rect = timelineSection.getBoundingClientRect();
          const offset = getScrollOffset();
          
          return rect.top <= offset + CONFIG.SNAP_DISTANCE && 
                rect.top >= offset - CONFIG.SNAP_DISTANCE;
      }
      
      function isTimelineApproachingFromBottom() {
          if (!timelineSection) return false;
          if (viewportLocked || isInCooldown()) return false;
          
          const rect = timelineSection.getBoundingClientRect();
          const viewportHeight = $(window).height();
          
          return rect.bottom >= viewportHeight - CONFIG.SNAP_DISTANCE && 
                rect.bottom <= viewportHeight + CONFIG.SNAP_DISTANCE;
      }
      
      // ============================================
      // POSITION DETECTION - IMPROVED
      // ============================================
      function isTimelineAboveViewport() {
          if (!timelineSection) return false;
          const rect = timelineSection.getBoundingClientRect();
          return rect.bottom < 0;
      }
      
      function isTimelineBelowViewport() {
          if (!timelineSection) return false;
          const rect = timelineSection.getBoundingClientRect();
          const viewportHeight = $(window).height();
          return rect.top > viewportHeight;
      }
      
      // ============================================
      // SECTION NAVIGATION
      // ============================================
      function findNextElementorSection() {
          const $parentSection = $timelineWrapper.closest('.elementor-section');
          
          if ($parentSection.length === 0) return null;
          
          let $next = $parentSection.nextAll('.elementor-section:visible').first();
          
          if ($next.length === 0) {
              $next = $('footer:visible, .site-footer:visible').first();
          }
          
          return $next.length > 0 ? $next : null;
      }
      
      function findMapSection() {
          const $mapSection = $('.elementor-section[data-id="' + CONFIG.MAP_SECTION_ID + '"]');
          return $mapSection.length > 0 && $mapSection.is(':visible') ? $mapSection : null;
      }
      
      function transitionToNext() {
          if (isTransitioning) return;
          
          console.log('‚û°Ô∏è Exiting to NEXT section');
          isTransitioning = true;
          unlockViewport();
          
          const $nextSection = findNextElementorSection();
          
          if (!$nextSection) {
              const targetTop = $(document).height() - $(window).height();
              $('html, body').stop(true, true).animate({
                  scrollTop: Math.max(0, targetTop)
              }, {
                  duration: CONFIG.TRANSITION_DURATION,
                  easing: CONFIG.TRANSITION_EASING,
                  complete: function() {
                      isTransitioning = false;
                  }
              });
              return;
          }
          
          const targetTop = $nextSection.offset().top;
          const scrollOffset = getScrollOffset();
          const finalScrollTop = Math.max(0, targetTop - scrollOffset);
          
          $('html, body').stop(true, true).animate({
              scrollTop: finalScrollTop
          }, {
              duration: CONFIG.TRANSITION_DURATION,
              easing: CONFIG.TRANSITION_EASING,
              complete: function() {
                  isTransitioning = false;
                  console.log('‚úÖ Next section reached');
              }
          });
      }
      
      function transitionToMap() {
          if (isTransitioning) return;
          
          console.log('‚¨ÖÔ∏è Exiting to MAP section');
          isTransitioning = true;
          unlockViewport();
          
          const $mapSection = findMapSection();
          
          if (!$mapSection) {
              console.error('‚ùå MAP section not found');
              isTransitioning = false;
              return;
          }
          
          const targetTop = $mapSection.offset().top;
          const scrollOffset = getScrollOffset();
          const finalScrollTop = Math.max(0, targetTop - scrollOffset);
          
          $('html, body').stop(true, true).animate({
              scrollTop: finalScrollTop
          }, {
              duration: CONFIG.TRANSITION_DURATION,
              easing: CONFIG.TRANSITION_EASING,
              complete: function() {
                  isTransitioning = false;
                  console.log('‚úÖ MAP section reached');
              }
          });
      }
      
      // ============================================
      // TIMELINE ANIMATIONS
      // ============================================
      function initializeTimeline() {
          animatedConnections.clear();
          
          circles.each(function(index, circle) {
              const $circle = $(circle);
              const centerDot = $circle.find('.center-dot')[0];
              
              if (centerDot) {
                  centerDot.classList.remove('animate');
              }
              
              $circle.removeClass('extend-line extend-vertical-lines top-extended');
              $circle.find('.line-text').removeClass('show');
              $circle.find('.year-label').removeClass('show top-small bottom-small');
              $circle.find('.project-data').removeClass('show top-big bottom-big');
              $circle.find('.bottom-line').removeClass('bottom-small');
          });
      }
      
      function isElementVisible(el, container) {
          if (!el || !container) return false;
          
          const elRect = el.getBoundingClientRect();
          const contRect = container.getBoundingClientRect();
          
          return (elRect.left >= contRect.left && elRect.left <= contRect.right) ||
                (elRect.right >= contRect.left && elRect.right <= contRect.right) ||
                (elRect.left <= contRect.left && elRect.right >= contRect.right);
      }
      
      function animateConnection(index) {
          if (animatedConnections.has(index)) return;
          
          const currentCircle = circles.eq(index);
          const centerDot = currentCircle.find('.center-dot')[0];
          
          if (centerDot && !centerDot.classList.contains('animate')) {
              centerDot.classList.add('animate');
              
              setTimeout(() => {
                  if (index > 0) {
                      const prevCircle = circles.eq(index - 1);
                      prevCircle.addClass('extend-line');
                      setTimeout(() => {
                          prevCircle.find('.line-text').addClass('show');
                      }, 1400);
                  }
                  
                  currentCircle.addClass('extend-vertical-lines');
                  const yearLabel = currentCircle.find('.year-label');
                  const projectData = currentCircle.find('.project-data');
                  const bottomLine = currentCircle.find('.bottom-line');
                  
                  if (index % 2 === 0) {
                      bottomLine.removeClass('bottom-small');
                      projectData.addClass('bottom-big show');
                  } else {
                      currentCircle.addClass('top-extended');
                      bottomLine.addClass('bottom-small');
                      yearLabel.addClass('bottom-small show');
                      projectData.addClass('top-big show');
                  }
                  
                  setTimeout(() => {
                      if (index % 2 === 0) {
                          yearLabel.addClass('top-small show');
                      }
                  }, 300);
                  
                  animatedConnections.add(index);
              }, 600);
          }
      }
      
      function checkVisibleCircles() {
          if (!scrollContainer) return;
          
          circles.each(function(index, circle) {
              if (isElementVisible(circle, scrollContainer)) {
                  animateConnection(index);
              }
          });
      }
      
      // ============================================
      // SCROLL HANDLERS - IMPROVED
      // ============================================
      let lastPageScrollY = 0;
      
      function handleMainPageScroll(event) {
          if (isTransitioning || justExitedTimeline || allowPageScroll) {
              return;
          }
          
          const currentScrollY = $(window).scrollTop();
          const scrollingDown = currentScrollY > lastPageScrollY;
          lastPageScrollY = currentScrollY;
          
          if (!viewportLocked && scrollingDown && isTimelineInViewport() && shouldLockToTimeline()) {
              console.log('‚¨áÔ∏è Approaching timeline from TOP');
              event.preventDefault();
              lockViewportToTimeline('down');
              return false;
          }
          
          if (!viewportLocked && !scrollingDown && isTimelineInViewport() && isTimelineApproachingFromBottom()) {
              console.log('‚¨ÜÔ∏è Approaching timeline from BOTTOM');
              event.preventDefault();
              lockViewportToTimeline('up');
              return false;
          }
          
          if (viewportLocked && preventScroll) {
              event.preventDefault();
              return false;
          }
      }
      
      function initializeScrollNavigation() {
          if (!scrollContainer) {
              console.error('‚ùå Scroll container not available');
              return;
          }
          
          console.log('üéØ Initializing timeline scroll');
          
          $(scrollContainer).off('.timeline-scroll');
          
          const scrollHandler = function(event) {
              if (!viewportLocked && !isTimelineLocked) {
                  return;
              }
              
              event.preventDefault();
              event.stopPropagation();
              
              if (isTransitioning) {
                  return false;
              }
              
              const e = event.originalEvent || event;
              const deltaY = e.deltaY || e.detail || (-e.wheelDelta);
              
              if (!deltaY || Math.abs(deltaY) < CONFIG.MIN_SCROLL_DELTA) {
                  return false;
              }
              
              const oldScrollLeft = scrollContainer.scrollLeft;
              scrollContainer.scrollLeft += deltaY;
              const newScrollLeft = scrollContainer.scrollLeft;
              const maxScrollLeft = scrollContainer.scrollWidth - scrollContainer.clientWidth;
              
              checkVisibleCircles();
              
              const scrollDirection = deltaY;
              
              if (Math.sign(scrollDirection) === Math.sign(lastScrollDirection) || lastScrollDirection === 0) {
                  scrollAccumulation += Math.abs(scrollDirection);
              } else {
                  scrollAccumulation = Math.abs(scrollDirection);
              }
              lastScrollDirection = scrollDirection;
              
              const isAtLeftBoundary = newScrollLeft <= CONFIG.BOUNDARY_THRESHOLD;
              const isAtRightBoundary = newScrollLeft >= (maxScrollLeft - CONFIG.BOUNDARY_THRESHOLD);
              
              if (isAtLeftBoundary && scrollDirection < 0) {
                  if (scrollAccumulation >= CONFIG.SCROLL_ACCUMULATION_NEEDED) {
                      console.log('üöÄ Exiting LEFT to MAP');
                      transitionToMap();
                      return false;
                  }
              }
              else if (isAtRightBoundary && scrollDirection > 0) {
                  if (scrollAccumulation >= CONFIG.SCROLL_ACCUMULATION_NEEDED) {
                      console.log('üöÄ Exiting RIGHT to NEXT');
                      transitionToNext();
                      return false;
                  }
              }
              else {
                  scrollAccumulation = 0;
              }
              
              clearTimeout(scrollResetTimeout);
              scrollResetTimeout = setTimeout(() => {
                  scrollAccumulation = 0;
              }, CONFIG.SCROLL_RESET_DELAY);
              
              return false;
          };
          
          $(scrollContainer).on('wheel.timeline-scroll DOMMouseScroll.timeline-scroll mousewheel.timeline-scroll', scrollHandler);
          
          // Touch support
          let touchStartX = 0;
          let touchDeltaX = 0;
          
          $(scrollContainer).on('touchstart.timeline-scroll', function(e) {
              if (!viewportLocked) return;
              touchStartX = e.originalEvent.touches[0].clientX;
              touchDeltaX = 0;
          });
          
          $(scrollContainer).on('touchmove.timeline-scroll', function(e) {
              if (!viewportLocked || isTransitioning) return;
              
              const touch = e.originalEvent.touches[0];
              const deltaX = touch.clientX - touchStartX;
              
              e.preventDefault();
              scrollContainer.scrollLeft -= deltaX;
              touchStartX = touch.clientX;
              touchDeltaX = deltaX;
              checkVisibleCircles();
          });
          
          $(scrollContainer).on('touchend.timeline-scroll', function(e) {
              if (!viewportLocked || isTransitioning) return;
              
              if (Math.abs(touchDeltaX) > 60) {
                  const currentScrollLeft = scrollContainer.scrollLeft;
                  const maxScrollLeft = scrollContainer.scrollWidth - scrollContainer.clientWidth;
                  
                  if (touchDeltaX > 0 && currentScrollLeft <= CONFIG.BOUNDARY_THRESHOLD) {
                      transitionToMap();
                  } else if (touchDeltaX < 0 && currentScrollLeft >= (maxScrollLeft - CONFIG.BOUNDARY_THRESHOLD)) {
                      transitionToNext();
                  }
              }
          });
          
          console.log('‚úÖ Scroll handlers active');
      }
      
      // ============================================
      // INITIALIZATION
      // ============================================
      function waitForElementor(callback) {
          if (typeof elementorFrontend !== 'undefined') {
              callback();
          } else {
              setTimeout(() => waitForElementor(callback), 100);
          }
      }
      
      function initializeWhenReady() {
          $(document).ready(function() {
              console.log('üìÑ Initializing timeline system');
              
              detectWordPressEnvironment();
              
              scrollContainer = document.getElementById('timeline-scroll');
              if (!scrollContainer) {
                  console.error('‚ùå Timeline container not found');
                  return;
              }
              
              $timelineWrapper = $(scrollContainer).closest('.elementor-widget-container, .timeline-wrapper, [class*="timeline"]').first();
              
              if ($timelineWrapper.length === 0) {
                  $timelineWrapper = $(scrollContainer).parent();
              }
              
              timelineSection = scrollContainer.closest('.elementor-section, [data-elementor-type], section');
              
              circles = $('.point');
              if (circles.length === 0) {
                  console.error('‚ùå No timeline points found');
                  return;
              }
              
              console.log('‚úÖ Timeline points:', circles.length);
              
              const $mapCheck = findMapSection();
              if ($mapCheck) {
                  console.log('‚úÖ MAP section ready:', CONFIG.MAP_SECTION_ID);
              } else {
                  console.warn('‚ö†Ô∏è MAP section not found!');
              }
              
              if (isWordPress && typeof elementorFrontend !== 'undefined') {
                  waitForElementor(() => {
                      setTimeout(initializeTimeline, 300);
                      setTimeout(checkVisibleCircles, 800);
                      setTimeout(initializeScrollNavigation, 1000);
                  });
              } else {
                  setTimeout(initializeTimeline, 200);
                  setTimeout(checkVisibleCircles, 600);
                  setTimeout(initializeScrollNavigation, 800);
              }
              
              $(window).on('wheel.timeline-page DOMMouseScroll.timeline-page mousewheel.timeline-page', handleMainPageScroll);
              
              // ============================================
              // FIXED: Scroll monitor with proper reset logic
              // ============================================
              let scrollMonitorTimeout;
              $(window).on('scroll.timeline-monitor', function() {
                  clearTimeout(scrollMonitorTimeout);
                  scrollMonitorTimeout = setTimeout(function() {
                      const currentScrollY = $(window).scrollTop();
                      const scrollingDown = currentScrollY > lastPageScrollY;
                      
                      // Track if user has been below the timeline
                      if (isTimelineBelowViewport()) {
                          hasBeenBelowTimeline = true;
                      }
                      
                      // NEW LOGIC: Reset timeline when scrolling UP past it (going towards MAP)
                      // This should work REGARDLESS of other state flags
                      if (!scrollingDown && isTimelineAboveViewport() && hasBeenBelowTimeline && !timelineScrolledPast) {
                          console.log('üîÑ Timeline passed while scrolling UP - Resetting to start');
                          resetTimelineToStart();
                      }
                      
                      // Only check locking conditions if not in transition states
                      if (!isTransitioning && !viewportLocked && !justExitedTimeline && !allowPageScroll) {
                          lastPageScrollY = currentScrollY;
                          
                          if (scrollingDown && isTimelineInViewport() && shouldLockToTimeline()) {
                              lockViewportToTimeline('down');
                          } else if (!scrollingDown && isTimelineInViewport() && isTimelineApproachingFromBottom()) {
                              lockViewportToTimeline('up');
                          }
                      }
                  }, 100);
              });
              
              console.log('‚úÖ System ready');
          });
      }
      
      if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initializeWhenReady);
      } else {
          initializeWhenReady();
      }
      
      $(window).on('resize.timeline-scroll orientationchange.timeline-scroll', function() {
          detectWordPressEnvironment();
          if (viewportLocked) {
              unlockViewport();
          }
          setTimeout(checkVisibleCircles, 100);
      });
      
  })(jQuery);
  </script>

</body>
</html>
